---
title: "Analyzing handwritten documents with handwriter"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{handwriter-writership-analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{coda}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
```

```{r setup, echo = FALSE}
library(handwriter)
```


## Main template directory
```{r}
main_dir <- file.path(getwd(), "handwriter_example_new")

# create the directory if it doesn't already exist
if(!dir.exists(main_dir)){dir.create(main_dir)}
```


## Create template
```{r}
template_images_dir <- system.file("extdata/example_images/template_training_images", 
                                   package = "handwriter")

template_list <- make_clustering_templates(template_dir = main_dir,
                                           template_images_dir = template_images_dir,
                                           writer_indices = c(2,5),
                                           K = 10,
                                           num_dist_cores = 2,
                                           max_iters = 3,
                                           num_graphs = 1000,
                                           starting_seed = 100,
                                           num_runs = 1)
```

Plot the cluster fill counts for each document in the template training set.
```{r}
template_data <- format_template_data(template = template_list[[1]])
plot_cluster_fill_counts(template_data, facet = TRUE)
```


```{r}
model_images_dir <- system.file("extdata/example_images/model_training_images", 
                                package = "handwriter")
```

Process the model training documents to transform the handwriting into graphs. Output the processed graphs to main_dir > data > model_graphs. The function will create this directory automatically.
```{r}
# process the handwriting
model_proc_list <- process_batch_dir(input_dir = model_images_dir,
                                     output_dir = file.path(main_dir, "data", "model_graphs"),
                                     transform_output = 'document')
```
  
Use the cluster template to assign the processed model training graphs to the nearest cluster. `template_list` is a list of templates so we access the first (and only in this case) template with `template_list[[1]]`.
```{r}  
model_clusters <- get_clusterassignment(clustertemplate = template_list[[1]],
                                        input_dir = file.path(main_dir, "data", "model_graphs"))
```

Format the model training data for the hierarchical model. The writer IDs are recorded in the model training documents' file names in characters 2-5. The remainder of the file name can be use as the document name to distinguish between multiple documents from the same writer. The 6th character is an underscore, so we choose to omit it here.

**TO DO: Explain model parameters**
```{r}
model_data <- format_model_data(model_proc_list = model_clusters, 
                                writer_indices = c(2,5), 
                                doc_indices = c(7,18), 
                                a = 2, b = 0.25, c = 2, d = 2, e = 0.5)
```

Plot the cluster fill counts for the model training documents.
```{r}
plot_cluster_fill_counts(model_data, facet = TRUE)
```

Now that the model training data has been properly formatted, we can fit the model. The `fit_model` function 
is a wrapped for `rjags::jags.model`. The RJAGS model that we use is 
```{r comment='', echo=FALSE}
cat(readLines("model_wrapped_cauchy.txt"), sep = '\n')
```

For this example we use 100 MCMC iterations for the model in interest of speed. In practice you will likely need to use more iterations.
```{r}
model <- fit_model(model_data, num_iters = 100)
```

See [handwriter model diagnostics](model-diagnostics.html) for information on available model diagnostic tools.

Drop the first 25 MCMC iterations for burn-in.
```{r}
model <- drop_burnin(model, burn_in = 25)
```

## Analyze Questioned Documents
We will use the "questioned" documents included in handwriter. In this case, we know the ground truth of who wrote each document so we will be able to measure the accuracy. Get the file path to these documents.
```{r}
questioned_images_dir <- system.file("extdata/example_images/questioned_images", 
                                     package = "handwriter")
```

Process the questioned documents to transform the handwriting into graphs. Output the processed graphs to main_dir > data > questioned_graphs. The function will create this directory automatically.
```{r}
questioned_proc_list <- process_batch_dir(input_dir = questioned_images_dir,
                                          output_dir = file.path(main_dir, "data", "questioned_graphs"),
                                          transform_output = 'document')
```

Use the cluster template to assign the processed questioned graphs to the nearest cluster. Again, `template_list` is a list of templates so we access the first (and only in this case) template with `template_list[[1]]`.
```{r}
questioned_clusters <- get_clusterassignment(clustertemplate = template_list[[1]], 
                                             input_dir = file.path(main_dir, "data", "questioned_graphs"))
```

Format the questioned data so that we can use it with the fitted model. As with the model documents, the write ID is contained in characters 2-5 of the filename and we use the remainder of the file name, minus the underscore in the 6th character, as the document name in case a writer has multiple documents. In practice, we would not know the writer of a questioned document so we would assign a unique identifier at the beginning of the document's filename.
```{r}
questioned_data <- format_questioned_data(formatted_model_data = model_data,
                                          questioned_proc_list = questioned_clusters,
                                          writer_indices=c(2,5), 
                                          doc_indices=c(7,18))
```

Plot the cluster fill counts for the questioned documents.
```{r}
plot_cluster_fill_counts(questioned_data, facet = TRUE)
```

Use the fitted model to estimate the posterior probability of writership.
```{r}
analysis <- analyze_questioned_documents(model_data = model_data, 
                                         model = model, 
                                         questioned_data = questioned_data, 
                                         num_cores = 2)
```

Plot the posterior probabilities of writership.
```{r out.width="100%", fig.cap="Posterior probabilities of writership."}
plot_posterior_probabilities(analysis)
```

